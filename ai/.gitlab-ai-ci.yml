stages:
  - transfer-model

transfer-model:
  stage: transfer-model
  image: jonz94/rsync-ssh-alpine:3.1.3-6

  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 --decode > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa

  script:
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "echo ✅ EC2 SSH 연결 성공!"
    # 대상 디렉토리 생성 보장
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p /home/ubuntu/ai-server/ai/src/app/resources/"
    # 완전한 동기화 (로컬에 없는 파일은 원격에서도 삭제)
    - rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" ./src/app/resources/ "$DEPLOY_USER@$DEPLOY_HOST:/home/ubuntu/ai-server/ai/src/app/resources/"
    # 동기화 완료 확인
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "ls -la /home/ubuntu/ai-server/ai/src/app/resources/"
    # 백업 생성 (날짜와 시간을 포함한 디렉토리에 저장)
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p /home/ubuntu/ai-server/backups/resources-\$(date +%Y%m%d-%H%M%S) && cp -r /home/ubuntu/ai-server/ai/src/app/resources/* /home/ubuntu/ai-server/backups/resources-\$(date +%Y%m%d-%H%M%S)/ && echo '✅ 백업 생성 완료!'"
    # 백업 목록 확인
    - ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" "ls -la /home/ubuntu/ai-server/backups/"
    - echo "✅ 모델 파일 전송 및 동기화 완료!"