<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 API 테스트</title>
    <!-- favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔐</text></svg>">
    <style>
        /* --- base layout --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        h1, h2 { color: #333; }
        /* --- card component --- */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            cursor: pointer;
            padding: 10px 15px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #45a049; }
        /* --- result area --- */
        #resultContainer {
            background-color: #f9f9f9;
            border-left: 3px solid #4CAF50;
            padding: 15px;
            margin-top: 20px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        /* --- file list grid --- */
        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .file-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .file-preview {
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 10px;
            background-color: #eee;
        }
        .file-preview img,
        .file-preview video { max-width: 100%; max-height: 100%; }
        .file-info { font-size: 12px; }
        /* --- tabs --- */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 15px; cursor: pointer; }
        .tab.active { border-bottom: 2px solid #4CAF50; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <h1>S3 API 테스트</h1>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="upload">업로드</div>
        <div class="tab" data-tab="files">파일 목록</div>
        <div class="tab" data-tab="get">단일 파일</div>
        <div class="tab" data-tab="delete">파일 삭제</div>
    </div>

    <!-- Upload Tab -->
    <div class="tab-content active" id="upload">
        <div class="card">
            <h2>1. 파일 업로드</h2>
            <div class="form-group">
                <label for="uploadFile">파일 선택:</label>
                <input type="file" id="uploadFile">
            </div>
            <div class="form-group">
                <label for="fileType">파일 타입:</label>
                <select id="fileType">
                    <option value="Image">이미지</option>
                    <option value="Video">비디오</option>
                </select>
            </div>
            <button id="getPresignedUrlBtn">Presigned URL 얻기</button>

            <div id="uploadResultContainer" style="display:none;">
                <h3>Presigned URL 정보</h3>
                <div class="form-group">
                    <label>생성된 파일명:</label>
                    <input type="text" id="generatedFileName" readonly>
                </div>
                <div class="form-group">
                    <label>Presigned URL:</label>
                    <input type="text" id="presignedUrl" readonly>
                </div>
                <button id="uploadToS3Btn">S3에 업로드</button>
                <div class="form-group" id="uploadProgressContainer" style="display:none;">
                    <label>업로드 진행:</label>
                    <progress id="uploadProgress" value="0" max="100"></progress>
                    <span id="uploadStatus"></span>
                </div>
                <button id="confirmUploadBtn" style="display:none;">업로드 완료 확인</button>
            </div>
        </div>
    </div>

    <!-- Files Tab -->
    <div class="tab-content" id="files">
        <div class="card">
            <h2>2. 파일 목록 조회</h2>
            <div class="form-group">
                <label for="listFileType">파일 타입 선택:</label>
                <select id="listFileType">
                    <option value="all">모든 파일</option>
                    <option value="image">이미지</option>
                    <option value="video">비디오</option>
                </select>
            </div>
            <button id="listFilesBtn">파일 목록 조회</button>
            <div id="fileListContainer" class="file-list"></div>
        </div>
    </div>

    <!-- Get Tab -->
    <div class="tab-content" id="get">
        <div class="card">
            <h2>3. 단일 파일 조회</h2>
            <div class="form-group">
                <label for="fileSelect">파일 선택:</label>
                <select id="fileSelect" class="file-dropdown"><option value="">직접 입력</option></select>
            </div>
            <div class="form-group">
                <label for="fileName">파일명:</label>
                <input type="text" id="fileName" placeholder="파일명 입력 (UUID 포함)">
            </div>
            <button id="getFileBtn">파일 조회</button>
            <div id="fileDetailsContainer" style="display:none;"></div>
        </div>
    </div>

    <!-- Delete Tab -->
    <div class="tab-content" id="delete">
        <div class="card">
            <h2>4. 파일 삭제</h2>
            <div class="form-group">
                <label for="deleteFileSelect">파일 선택:</label>
                <select id="deleteFileSelect" class="file-dropdown"><option value="">직접 입력</option></select>
            </div>
            <div class="form-group">
                <label for="deleteFileName">파일명:</label>
                <input type="text" id="deleteFileName" placeholder="파일명 입력 (UUID 포함)">
            </div>
            <div class="form-group">
                <label for="deleteFileType">파일 타입:</label>
                <select id="deleteFileType"><option value="image">이미지</option><option value="video">비디오</option></select>
            </div>
            <button id="deleteFileBtn">파일 삭제</button>
        </div>
    </div>

    <!-- Result Area -->
    <div class="card"><h2>응답 결과</h2><div id="resultContainer"></div></div>

    <script>
        /* ----------------- CONFIG ----------------- */
        // 테스트 환경에서 확인하세요
        // const API_BASE_URL = 'http://localhost:8001/api/s3';
        const API_BASE_URL = 'http://15.165.100.79:8001/api/s3';

        /* ----------------- HELPER ----------------- */
        function showResult(text) {
            document.getElementById('resultContainer').innerText = text;
        }

        function formatFileSize(bytes){
            if(bytes === 0) return '0 Bytes';
            const k=1024,sizes=['Bytes','KB','MB','GB','TB'];
            const i=Math.floor(Math.log(bytes)/Math.log(k));
            return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];
        }

        /**
         * 공통 비디오 요소 생성 – type="video/mp4" 를 명시적으로 넣어 브라우저가 오디오로 오인하지 않도록 한다.
         */
        function createVideoElement(src, width, height, contentType='video/mp4'){
            const video=document.createElement('video');
            video.controls=true;
            video.width=width;
            video.height=height;
            video.style.display='block';
            video.style.width='100%';
            video.style.height='auto';
            video.style.objectFit='contain';

            const source=document.createElement('source');
            source.src=src;
            source.type=contentType;
            video.appendChild(source);
            return video;
        }

        /* ----------------- DOMContentLoaded ----------------- */
        document.addEventListener('DOMContentLoaded',()=>{
            /* ---- 탭 전환 ---- */
            document.querySelectorAll('.tab').forEach(tab=>{
                tab.addEventListener('click',function(){
                    const tabId=this.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });

            /* ---- 1. Presigned URL ---- */
            document.getElementById('getPresignedUrlBtn').addEventListener('click',async()=>{
                const fileInput=document.getElementById('uploadFile');
                if(!fileInput.files.length){ showResult('파일을 선택해주세요.'); return; }
                const file=fileInput.files[0];
                const fileType=document.getElementById('fileType').value;

                try{
                    const res=await fetch(`${API_BASE_URL}/presigned-url`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({
                            fileName:file.name,
                            fileType:fileType,
                            size:file.size,
                            contentType:file.type
                        })
                    });
                    const data=await res.json();
                    showResult(JSON.stringify(data,null,2));
                    document.getElementById('generatedFileName').value=data.fileName;
                    document.getElementById('presignedUrl').value=data.presignedUrl;
                    document.getElementById('uploadResultContainer').style.display='block';
                }catch(err){ showResult('오류 발생: '+err); }
            });

            /* ---- 2. S3 업로드 ---- */
            document.getElementById('uploadToS3Btn').addEventListener('click',()=>{
                const fileInput=document.getElementById('uploadFile');
                const presignedUrl=document.getElementById('presignedUrl').value;
                if(!presignedUrl){ showResult('Presigned URL이 없습니다.'); return; }
                if(!fileInput.files.length){ showResult('파일을 선택해주세요.'); return; }
                const file=fileInput.files[0];

                const progress=document.getElementById('uploadProgress');
                const status=document.getElementById('uploadStatus');
                document.getElementById('uploadProgressContainer').style.display='block';

                const xhr=new XMLHttpRequest();
                xhr.open('PUT',presignedUrl);
                xhr.setRequestHeader('x-amz-meta-originalfilename',file.name);
                // 👉 비디오가 오디오로 인식되는 문제를 방지하기 위해 Content-Type을 명시적으로 전송
                xhr.setRequestHeader('Content-Type',file.type);

                xhr.upload.onprogress=e=>{
                    if(e.lengthComputable){ const pct=(e.loaded/e.total)*100; progress.value=pct; status.textContent=`${Math.round(pct)}% 완료`; }
                };
                xhr.onload=()=>{
                    if(xhr.status===200){ status.textContent='업로드 완료!'; document.getElementById('confirmUploadBtn').style.display='block'; }
                    else{ status.textContent='업로드 실패: '+xhr.statusText; }
                };
                xhr.onerror=()=>{ status.textContent='네트워크 오류 발생'; };
                xhr.send(file);
            });

            /* ---- 3. 업로드 완료 확인 ---- */
            document.getElementById('confirmUploadBtn').addEventListener('click',async()=>{
                const fileName=document.getElementById('generatedFileName').value;
                const fileInput=document.getElementById('uploadFile');
                const originalFileName=fileInput.files[0].name;
                const fileType=document.getElementById('fileType').value;
                const size=fileInput.files[0].size;
                try{
                    const res=await fetch(`${API_BASE_URL}/confirm-upload`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({fileName,originalFileName,fileType,size})
                    });
                    const data=await res.json().catch(()=>({}));
                    showResult('업로드 확인 완료!\n'+JSON.stringify(data,null,2));
                }catch(err){ showResult('오류 발생: '+err); }
            });

            /* ---- 4. 파일 목록 조회 ---- */
            document.getElementById('listFilesBtn').addEventListener('click',async()=>{
                const fileType=document.getElementById('listFileType').value;
                let endpoint=`${API_BASE_URL}/files`;
                if(fileType!=='all') endpoint=`${API_BASE_URL}/files/${fileType}`;
                try{
                    const res=await fetch(endpoint);
                    if(res.status===204) throw new Error('파일이 없습니다.');
                    const data=await res.json();
                    showResult(JSON.stringify(data,null,2));
                    displayFileList(data.files);
                }catch(err){ showResult('오류 발생: '+err); document.getElementById('fileListContainer').innerHTML=''; }
            });

            /* ---- 5. 단일 파일 조회 ---- */
            document.getElementById('getFileBtn').addEventListener('click',async()=>{
                const fileName=document.getElementById('fileName').value.trim();
                if(!fileName){ showResult('파일명을 입력해주세요.'); return; }
                try{
                    const res=await fetch(`${API_BASE_URL}/file/${fileName}`);
                    if(!res.ok) throw new Error('파일을 찾을 수 없습니다.');
                    const data=await res.json();
                    showResult(JSON.stringify(data,null,2));
                    displayFileDetails(data);
                }catch(err){ showResult('오류 발생: '+err); document.getElementById('fileDetailsContainer').style.display='none'; }
            });

            /* ---- 6. 파일 삭제 ---- */
            document.getElementById('deleteFileBtn').addEventListener('click',async()=>{
                const fileName=document.getElementById('deleteFileName').value.trim();
                const fileType=document.getElementById('deleteFileType').value;
                if(!fileName){ showResult('파일명을 입력해주세요.'); return; }
                if(!confirm(`정말 파일 "${fileName}"을(를) 삭제하시겠습니까?`)) return;
                try{
                    showResult('파일 삭제 중...');
                    const res=await fetch(`${API_BASE_URL}/files/${fileType}/${fileName}`,{method:'DELETE'});
                    if(!res.ok){ if(res.status===404) throw new Error(`파일 "${fileName}"을(를) 찾을 수 없습니다.`); throw new Error('삭제 실패: '+res.status); }
                    const data=await res.json().catch(()=>({ message:'파일이 성공적으로 삭제되었습니다.' }));
                    showResult('파일 삭제 완료!\n'+JSON.stringify(data,null,2));
                    document.getElementById('deleteFileName').value='';
                    document.querySelector('.tab[data-tab="files"]').click();
                    document.getElementById('listFilesBtn').click();
                }catch(err){ showResult('오류 발생: '+err.message); }
            });

            /* ---- 드롭다운 갱신 ---- */
            async function populateFileDropdowns(){
                try{
                    const res=await fetch(`${API_BASE_URL}/files`);
                    const data=res.status===204?{files:[]}:await res.json();
                    const files=data.files||[];
                    const fileSelect=document.getElementById('fileSelect');
                    const deleteFileSelect=document.getElementById('deleteFileSelect');
                    // reset (keep 첫 옵션)
                    fileSelect.length=1; deleteFileSelect.length=1;
                    files.forEach(f=>{
                        const opt=new Option(`${f.originalFileName} (${f.fileName})`,f.fileName);
                        opt.dataset.fileType=f.fileType==='Image'?'image':'video';
                        const opt2=opt.cloneNode(true);
                        fileSelect.add(opt); deleteFileSelect.add(opt2);
                    });
                }catch(e){ console.error('파일 목록 로드 오류:',e); }
            }
            document.querySelectorAll('.tab').forEach(tab=>{
                tab.addEventListener('click',function(){ const tabId=this.dataset.tab; if(tabId==='get'||tabId==='delete') populateFileDropdowns(); });
            });
            document.getElementById('fileSelect').addEventListener('change',function(){ document.getElementById('fileName').value=this.value; });
            document.getElementById('deleteFileSelect').addEventListener('change',function(){
                document.getElementById('deleteFileName').value=this.value;
                const selOpt=this.options[this.selectedIndex];
                if(selOpt.dataset.fileType){ document.getElementById('deleteFileType').value=selOpt.dataset.fileType; }
            });
        });

        /* ----------------- UI RENDERERS ----------------- */
        function displayFileList(files){
            const container=document.getElementById('fileListContainer');
            container.innerHTML='';
            if(!files||!files.length){ container.innerHTML='<p>파일이 없습니다.</p>'; return; }
            files.forEach(file=>{
                const item=document.createElement('div'); item.className='file-item';
                const preview=document.createElement('div'); preview.className='file-preview';
                if(file.fileType==='Image'){
                    const img=document.createElement('img'); img.src=file.presignedUrl||file.url; preview.appendChild(img);
                }else if(file.fileType==='Video'){
                    const vid=createVideoElement(file.presignedUrl||file.url,200,140,file.contentType||'video/mp4'); preview.appendChild(vid);
                }
                const info=document.createElement('div'); info.className='file-info';
                info.innerHTML=`<p><strong>파일명:</strong> ${file.fileName}</p>
                                 <p><strong>원본명:</strong> ${file.originalFileName}</p>
                                 <p><strong>크기:</strong> ${formatFileSize(file.size)}</p>
                                 <p><strong>타입:</strong> ${file.contentType}</p>
                                 <p><a href="${file.presignedUrl||file.url}" target="_blank">다운로드</a></p>`;
                item.appendChild(preview); item.appendChild(info); container.appendChild(item);
            });
        }

        function displayFileDetails(file){
            const container=document.getElementById('fileDetailsContainer');
            container.style.display='block'; container.innerHTML='';
            const preview=document.createElement('div'); preview.className='file-preview';
            if(file.fileType==='Image'){
                const img=document.createElement('img'); img.src=file.presignedUrl||file.url; preview.appendChild(img);
            }else if(file.fileType==='Video'){
                const vid=createVideoElement(file.presignedUrl||file.url,320,240,file.contentType||'video/mp4'); preview.appendChild(vid);
            }
            const info=document.createElement('div'); info.className='file-info';
            info.innerHTML=`<p><strong>파일명:</strong> ${file.fileName}</p>
                             <p><strong>원본명:</strong> ${file.originalFileName}</p>
                             <p><strong>크기:</strong> ${formatFileSize(file.size)}</p>
                             <p><strong>타입:</strong> ${file.contentType}</p>
                             <p><strong>업로드일:</strong> ${new Date(file.uploadDate).toLocaleString()}</p>
                             <p><a href="${file.presignedUrl||file.url}" target="_blank">다운로드</a></p>`;
            container.appendChild(preview); container.appendChild(info);
        }
    </script>
</body>
</html>
