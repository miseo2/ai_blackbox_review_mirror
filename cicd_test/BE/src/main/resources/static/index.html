<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 API í…ŒìŠ¤íŠ¸</title>
    <!-- favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”</text></svg>">
    <style>
        /* --- base layout --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        h1, h2 { color: #333; }
        /* --- card component --- */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            cursor: pointer;
            padding: 10px 15px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #45a049; }
        /* --- result area --- */
        #resultContainer {
            background-color: #f9f9f9;
            border-left: 3px solid #4CAF50;
            padding: 15px;
            margin-top: 20px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        /* --- file list grid --- */
        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .file-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .file-preview {
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 10px;
            background-color: #eee;
        }
        .file-preview img,
        .file-preview video { max-width: 100%; max-height: 100%; }
        .file-info { font-size: 12px; }
        /* --- tabs --- */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 15px; cursor: pointer; }
        .tab.active { border-bottom: 2px solid #4CAF50; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <h1>S3 API í…ŒìŠ¤íŠ¸</h1>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="upload">ì—…ë¡œë“œ</div>
        <div class="tab" data-tab="files">íŒŒì¼ ëª©ë¡</div>
        <div class="tab" data-tab="get">ë‹¨ì¼ íŒŒì¼</div>
        <div class="tab" data-tab="delete">íŒŒì¼ ì‚­ì œ</div>
    </div>

    <!-- Upload Tab -->
    <div class="tab-content active" id="upload">
        <div class="card">
            <h2>1. íŒŒì¼ ì—…ë¡œë“œ</h2>
            <div class="form-group">
                <label for="uploadFile">íŒŒì¼ ì„ íƒ:</label>
                <input type="file" id="uploadFile">
            </div>
            <div class="form-group">
                <label for="fileType">íŒŒì¼ íƒ€ì…:</label>
                <select id="fileType">
                    <option value="Image">ì´ë¯¸ì§€</option>
                    <option value="Video">ë¹„ë””ì˜¤</option>
                </select>
            </div>
            <button id="getPresignedUrlBtn">Presigned URL ì–»ê¸°</button>

            <div id="uploadResultContainer" style="display:none;">
                <h3>Presigned URL ì •ë³´</h3>
                <div class="form-group">
                    <label>ìƒì„±ëœ íŒŒì¼ëª…:</label>
                    <input type="text" id="generatedFileName" readonly>
                </div>
                <div class="form-group">
                    <label>Presigned URL:</label>
                    <input type="text" id="presignedUrl" readonly>
                </div>
                <button id="uploadToS3Btn">S3ì— ì—…ë¡œë“œ</button>
                <div class="form-group" id="uploadProgressContainer" style="display:none;">
                    <label>ì—…ë¡œë“œ ì§„í–‰:</label>
                    <progress id="uploadProgress" value="0" max="100"></progress>
                    <span id="uploadStatus"></span>
                </div>
                <button id="confirmUploadBtn" style="display:none;">ì—…ë¡œë“œ ì™„ë£Œ í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Files Tab -->
    <div class="tab-content" id="files">
        <div class="card">
            <h2>2. íŒŒì¼ ëª©ë¡ ì¡°íšŒ</h2>
            <div class="form-group">
                <label for="listFileType">íŒŒì¼ íƒ€ì… ì„ íƒ:</label>
                <select id="listFileType">
                    <option value="all">ëª¨ë“  íŒŒì¼</option>
                    <option value="image">ì´ë¯¸ì§€</option>
                    <option value="video">ë¹„ë””ì˜¤</option>
                </select>
            </div>
            <button id="listFilesBtn">íŒŒì¼ ëª©ë¡ ì¡°íšŒ</button>
            <div id="fileListContainer" class="file-list"></div>
        </div>
    </div>

    <!-- Get Tab -->
    <div class="tab-content" id="get">
        <div class="card">
            <h2>3. ë‹¨ì¼ íŒŒì¼ ì¡°íšŒ</h2>
            <div class="form-group">
                <label for="fileSelect">íŒŒì¼ ì„ íƒ:</label>
                <select id="fileSelect" class="file-dropdown"><option value="">ì§ì ‘ ì…ë ¥</option></select>
            </div>
            <div class="form-group">
                <label for="fileName">íŒŒì¼ëª…:</label>
                <input type="text" id="fileName" placeholder="íŒŒì¼ëª… ì…ë ¥ (UUID í¬í•¨)">
            </div>
            <button id="getFileBtn">íŒŒì¼ ì¡°íšŒ</button>
            <div id="fileDetailsContainer" style="display:none;"></div>
        </div>
    </div>

    <!-- Delete Tab -->
    <div class="tab-content" id="delete">
        <div class="card">
            <h2>4. íŒŒì¼ ì‚­ì œ</h2>
            <div class="form-group">
                <label for="deleteFileSelect">íŒŒì¼ ì„ íƒ:</label>
                <select id="deleteFileSelect" class="file-dropdown"><option value="">ì§ì ‘ ì…ë ¥</option></select>
            </div>
            <div class="form-group">
                <label for="deleteFileName">íŒŒì¼ëª…:</label>
                <input type="text" id="deleteFileName" placeholder="íŒŒì¼ëª… ì…ë ¥ (UUID í¬í•¨)">
            </div>
            <div class="form-group">
                <label for="deleteFileType">íŒŒì¼ íƒ€ì…:</label>
                <select id="deleteFileType"><option value="image">ì´ë¯¸ì§€</option><option value="video">ë¹„ë””ì˜¤</option></select>
            </div>
            <button id="deleteFileBtn">íŒŒì¼ ì‚­ì œ</button>
        </div>
    </div>

    <!-- Result Area -->
    <div class="card"><h2>ì‘ë‹µ ê²°ê³¼</h2><div id="resultContainer"></div></div>

    <script>
        /* ----------------- CONFIG ----------------- */
        // í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ í™•ì¸í•˜ì„¸ìš”
        // const API_BASE_URL = 'http://localhost:8001/api/s3';
        const API_BASE_URL = 'http://15.165.100.79:8001/api/s3';

        /* ----------------- HELPER ----------------- */
        function showResult(text) {
            document.getElementById('resultContainer').innerText = text;
        }

        function formatFileSize(bytes){
            if(bytes === 0) return '0 Bytes';
            const k=1024,sizes=['Bytes','KB','MB','GB','TB'];
            const i=Math.floor(Math.log(bytes)/Math.log(k));
            return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i];
        }

        /**
         * ê³µí†µ ë¹„ë””ì˜¤ ìš”ì†Œ ìƒì„± â€“ type="video/mp4" ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë„£ì–´ ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¡œ ì˜¤ì¸í•˜ì§€ ì•Šë„ë¡ í•œë‹¤.
         */
        function createVideoElement(src, width, height, contentType='video/mp4'){
            const video=document.createElement('video');
            video.controls=true;
            video.width=width;
            video.height=height;
            video.style.display='block';
            video.style.width='100%';
            video.style.height='auto';
            video.style.objectFit='contain';

            const source=document.createElement('source');
            source.src=src;
            source.type=contentType;
            video.appendChild(source);
            return video;
        }

        /* ----------------- DOMContentLoaded ----------------- */
        document.addEventListener('DOMContentLoaded',()=>{
            /* ---- íƒ­ ì „í™˜ ---- */
            document.querySelectorAll('.tab').forEach(tab=>{
                tab.addEventListener('click',function(){
                    const tabId=this.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });

            /* ---- 1. Presigned URL ---- */
            document.getElementById('getPresignedUrlBtn').addEventListener('click',async()=>{
                const fileInput=document.getElementById('uploadFile');
                if(!fileInput.files.length){ showResult('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                const file=fileInput.files[0];
                const fileType=document.getElementById('fileType').value;

                try{
                    const res=await fetch(`${API_BASE_URL}/presigned-url`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({
                            fileName:file.name,
                            fileType:fileType,
                            size:file.size,
                            contentType:file.type
                        })
                    });
                    const data=await res.json();
                    showResult(JSON.stringify(data,null,2));
                    document.getElementById('generatedFileName').value=data.fileName;
                    document.getElementById('presignedUrl').value=data.presignedUrl;
                    document.getElementById('uploadResultContainer').style.display='block';
                }catch(err){ showResult('ì˜¤ë¥˜ ë°œìƒ: '+err); }
            });

            /* ---- 2. S3 ì—…ë¡œë“œ ---- */
            document.getElementById('uploadToS3Btn').addEventListener('click',()=>{
                const fileInput=document.getElementById('uploadFile');
                const presignedUrl=document.getElementById('presignedUrl').value;
                if(!presignedUrl){ showResult('Presigned URLì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                if(!fileInput.files.length){ showResult('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
                const file=fileInput.files[0];

                const progress=document.getElementById('uploadProgress');
                const status=document.getElementById('uploadStatus');
                document.getElementById('uploadProgressContainer').style.display='block';

                const xhr=new XMLHttpRequest();
                xhr.open('PUT',presignedUrl);
                xhr.setRequestHeader('x-amz-meta-originalfilename',file.name);
                // ğŸ‘‰ ë¹„ë””ì˜¤ê°€ ì˜¤ë””ì˜¤ë¡œ ì¸ì‹ë˜ëŠ” ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ Content-Typeì„ ëª…ì‹œì ìœ¼ë¡œ ì „ì†¡
                xhr.setRequestHeader('Content-Type',file.type);

                xhr.upload.onprogress=e=>{
                    if(e.lengthComputable){ const pct=(e.loaded/e.total)*100; progress.value=pct; status.textContent=`${Math.round(pct)}% ì™„ë£Œ`; }
                };
                xhr.onload=()=>{
                    if(xhr.status===200){ status.textContent='ì—…ë¡œë“œ ì™„ë£Œ!'; document.getElementById('confirmUploadBtn').style.display='block'; }
                    else{ status.textContent='ì—…ë¡œë“œ ì‹¤íŒ¨: '+xhr.statusText; }
                };
                xhr.onerror=()=>{ status.textContent='ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ'; };
                xhr.send(file);
            });

            /* ---- 3. ì—…ë¡œë“œ ì™„ë£Œ í™•ì¸ ---- */
            document.getElementById('confirmUploadBtn').addEventListener('click',async()=>{
                const fileName=document.getElementById('generatedFileName').value;
                const fileInput=document.getElementById('uploadFile');
                const originalFileName=fileInput.files[0].name;
                const fileType=document.getElementById('fileType').value;
                const size=fileInput.files[0].size;
                try{
                    const res=await fetch(`${API_BASE_URL}/confirm-upload`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({fileName,originalFileName,fileType,size})
                    });
                    const data=await res.json().catch(()=>({}));
                    showResult('ì—…ë¡œë“œ í™•ì¸ ì™„ë£Œ!\n'+JSON.stringify(data,null,2));
                }catch(err){ showResult('ì˜¤ë¥˜ ë°œìƒ: '+err); }
            });

            /* ---- 4. íŒŒì¼ ëª©ë¡ ì¡°íšŒ ---- */
            document.getElementById('listFilesBtn').addEventListener('click',async()=>{
                const fileType=document.getElementById('listFileType').value;
                let endpoint=`${API_BASE_URL}/files`;
                if(fileType!=='all') endpoint=`${API_BASE_URL}/files/${fileType}`;
                try{
                    const res=await fetch(endpoint);
                    if(res.status===204) throw new Error('íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                    const data=await res.json();
                    showResult(JSON.stringify(data,null,2));
                    displayFileList(data.files);
                }catch(err){ showResult('ì˜¤ë¥˜ ë°œìƒ: '+err); document.getElementById('fileListContainer').innerHTML=''; }
            });

            /* ---- 5. ë‹¨ì¼ íŒŒì¼ ì¡°íšŒ ---- */
            document.getElementById('getFileBtn').addEventListener('click',async()=>{
                const fileName=document.getElementById('fileName').value.trim();
                if(!fileName){ showResult('íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                try{
                    const res=await fetch(`${API_BASE_URL}/file/${fileName}`);
                    if(!res.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    const data=await res.json();
                    showResult(JSON.stringify(data,null,2));
                    displayFileDetails(data);
                }catch(err){ showResult('ì˜¤ë¥˜ ë°œìƒ: '+err); document.getElementById('fileDetailsContainer').style.display='none'; }
            });

            /* ---- 6. íŒŒì¼ ì‚­ì œ ---- */
            document.getElementById('deleteFileBtn').addEventListener('click',async()=>{
                const fileName=document.getElementById('deleteFileName').value.trim();
                const fileType=document.getElementById('deleteFileType').value;
                if(!fileName){ showResult('íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if(!confirm(`ì •ë§ íŒŒì¼ "${fileName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                try{
                    showResult('íŒŒì¼ ì‚­ì œ ì¤‘...');
                    const res=await fetch(`${API_BASE_URL}/files/${fileType}/${fileName}`,{method:'DELETE'});
                    if(!res.ok){ if(res.status===404) throw new Error(`íŒŒì¼ "${fileName}"ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); throw new Error('ì‚­ì œ ì‹¤íŒ¨: '+res.status); }
                    const data=await res.json().catch(()=>({ message:'íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' }));
                    showResult('íŒŒì¼ ì‚­ì œ ì™„ë£Œ!\n'+JSON.stringify(data,null,2));
                    document.getElementById('deleteFileName').value='';
                    document.querySelector('.tab[data-tab="files"]').click();
                    document.getElementById('listFilesBtn').click();
                }catch(err){ showResult('ì˜¤ë¥˜ ë°œìƒ: '+err.message); }
            });

            /* ---- ë“œë¡­ë‹¤ìš´ ê°±ì‹  ---- */
            async function populateFileDropdowns(){
                try{
                    const res=await fetch(`${API_BASE_URL}/files`);
                    const data=res.status===204?{files:[]}:await res.json();
                    const files=data.files||[];
                    const fileSelect=document.getElementById('fileSelect');
                    const deleteFileSelect=document.getElementById('deleteFileSelect');
                    // reset (keep ì²« ì˜µì…˜)
                    fileSelect.length=1; deleteFileSelect.length=1;
                    files.forEach(f=>{
                        const opt=new Option(`${f.originalFileName} (${f.fileName})`,f.fileName);
                        opt.dataset.fileType=f.fileType==='Image'?'image':'video';
                        const opt2=opt.cloneNode(true);
                        fileSelect.add(opt); deleteFileSelect.add(opt2);
                    });
                }catch(e){ console.error('íŒŒì¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:',e); }
            }
            document.querySelectorAll('.tab').forEach(tab=>{
                tab.addEventListener('click',function(){ const tabId=this.dataset.tab; if(tabId==='get'||tabId==='delete') populateFileDropdowns(); });
            });
            document.getElementById('fileSelect').addEventListener('change',function(){ document.getElementById('fileName').value=this.value; });
            document.getElementById('deleteFileSelect').addEventListener('change',function(){
                document.getElementById('deleteFileName').value=this.value;
                const selOpt=this.options[this.selectedIndex];
                if(selOpt.dataset.fileType){ document.getElementById('deleteFileType').value=selOpt.dataset.fileType; }
            });
        });

        /* ----------------- UI RENDERERS ----------------- */
        function displayFileList(files){
            const container=document.getElementById('fileListContainer');
            container.innerHTML='';
            if(!files||!files.length){ container.innerHTML='<p>íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            files.forEach(file=>{
                const item=document.createElement('div'); item.className='file-item';
                const preview=document.createElement('div'); preview.className='file-preview';
                if(file.fileType==='Image'){
                    const img=document.createElement('img'); img.src=file.presignedUrl||file.url; preview.appendChild(img);
                }else if(file.fileType==='Video'){
                    const vid=createVideoElement(file.presignedUrl||file.url,200,140,file.contentType||'video/mp4'); preview.appendChild(vid);
                }
                const info=document.createElement('div'); info.className='file-info';
                info.innerHTML=`<p><strong>íŒŒì¼ëª…:</strong> ${file.fileName}</p>
                                 <p><strong>ì›ë³¸ëª…:</strong> ${file.originalFileName}</p>
                                 <p><strong>í¬ê¸°:</strong> ${formatFileSize(file.size)}</p>
                                 <p><strong>íƒ€ì…:</strong> ${file.contentType}</p>
                                 <p><a href="${file.presignedUrl||file.url}" target="_blank">ë‹¤ìš´ë¡œë“œ</a></p>`;
                item.appendChild(preview); item.appendChild(info); container.appendChild(item);
            });
        }

        function displayFileDetails(file){
            const container=document.getElementById('fileDetailsContainer');
            container.style.display='block'; container.innerHTML='';
            const preview=document.createElement('div'); preview.className='file-preview';
            if(file.fileType==='Image'){
                const img=document.createElement('img'); img.src=file.presignedUrl||file.url; preview.appendChild(img);
            }else if(file.fileType==='Video'){
                const vid=createVideoElement(file.presignedUrl||file.url,320,240,file.contentType||'video/mp4'); preview.appendChild(vid);
            }
            const info=document.createElement('div'); info.className='file-info';
            info.innerHTML=`<p><strong>íŒŒì¼ëª…:</strong> ${file.fileName}</p>
                             <p><strong>ì›ë³¸ëª…:</strong> ${file.originalFileName}</p>
                             <p><strong>í¬ê¸°:</strong> ${formatFileSize(file.size)}</p>
                             <p><strong>íƒ€ì…:</strong> ${file.contentType}</p>
                             <p><strong>ì—…ë¡œë“œì¼:</strong> ${new Date(file.uploadDate).toLocaleString()}</p>
                             <p><a href="${file.presignedUrl||file.url}" target="_blank">ë‹¤ìš´ë¡œë“œ</a></p>`;
            container.appendChild(preview); container.appendChild(info);
        }
    </script>
</body>
</html>
