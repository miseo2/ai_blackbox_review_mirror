stages:
  - jenkins-trigger

jenkins-trigger:
  stage: jenkins-trigger
  image: badouralix/curl-jq # curlê³¼ jqê°€ ì´ë¯¸ í¬í•¨ëœ ê²½ëŸ‰í™” ì´ë¯¸ì§€
  tags:
    - "ci / cd"
  variables:
    JOB_NAME: "ai-build-test" # íŠ¸ë¦¬ê±°í•  ì‘ì—… ì´ë¦„
    TRIGGER_URL: "$JENKINS_URL/job/$JOB_NAME/buildWithParameters" # íŠ¸ë¦¬ê±° URL
    TOKEN: "$JENKINS_JOB_TOKEN" # íŠ¸ë¦¬ê±° í† í°

  script: |
    set -euo pipefail

    echo "ğŸš€ Jenkins Job íŠ¸ë¦¬ê±° ì¤‘â€¦"
    # íŠ¸ë¦¬ê±° URLì— íŠ¸ë¦¬ê±° í† í°ê³¼ ë¸Œëœì¹˜ ì´ë¦„ ì¶”ê°€, url ë¬¸ìì—´ íŒŒì‹±
    RESPONSE_HEADERS=$(curl -siS -X POST "$TRIGGER_URL" \
      --user "$JENKINS_USER:$JENKINS_API_TOKEN" \
      --data-urlencode "token=$TOKEN" \
      --data-urlencode "BRANCH_NAME=$CI_COMMIT_REF_NAME" \
      --data-urlencode "GIT_REPO_URL=$(echo $CI_REPOSITORY_URL | sed -E 's#https://[^@]+@#https://#')") # ì¸ì¦ ì •ë³´ë§Œ ì œê±°í•˜ê³  https:// ìœ ì§€

    # jenkins ë¹Œë“œ ë²ˆí˜¸ ì¶”ì¶œ
    # Location í—¤ë”ì—ì„œ "/queue/item/123/" ì¶”ì¶œ
    QUEUE_PATH=$(echo "$RESPONSE_HEADERS" \
      | grep -i '^Location:' \
      | awk '{print $2}' \
      | sed -E 's#https?://[^/]+(/queue/item/[0-9]+/)#\1#' \
      | tr -d '\r')
    echo "ğŸ“‹ Queue Path: $QUEUE_PATH"

    echo "ğŸ“¡ ë¹Œë“œ ë²ˆí˜¸ ëŒ€ê¸° ì¤‘â€¦"
    BUILD_NUMBER=""
    for i in $(seq 1 30); do
      INFO=$(curl -sS \
        --user "$JENKINS_USER:$JENKINS_API_TOKEN" \
        "$JENKINS_URL${QUEUE_PATH}api/json")
      BUILD_NUMBER=$(echo "$INFO" | jq -r '.executable.number // empty')
      if [ -n "$BUILD_NUMBER" ]; then
        echo "âœ… ì‹¤ì œ ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER"
        break
      fi
      echo "â³ ì•„ì§ í ëŒ€ê¸° ì¤‘ ($i)â€¦"
      sleep 2
    done
    if [ -z "$BUILD_NUMBER" ]; then
      echo "âŒ ë¹Œë“œ ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
      exit 1
    fi

    # ë¹Œë“œ ìƒíƒœ ì¶”ì 
    echo "ğŸ” ë¹Œë“œ ìƒíƒœ ì¶”ì  ì‹œì‘: #$BUILD_NUMBER"
    JOB_API="$JENKINS_URL/job/$JOB_NAME/$BUILD_NUMBER/api/json"
    elapsed=0
    while [ $elapsed -lt 300 ]; do
      RESULT=$(curl -sS \
        --user "$JENKINS_USER:$JENKINS_API_TOKEN" \
        "$JOB_API" \
        | jq -r '.result // "BUILDING"')
      if [ "$RESULT" != "BUILDING" ]; then
        if [ "$RESULT" = "SUCCESS" ]; then
          echo "âœ… Jenkins build #$BUILD_NUMBER SUCCESS"
          exit 0
        else
          echo "âŒ Jenkins build #$BUILD_NUMBER FAILED: $RESULT"
          echo "=== Jenkins Console (last 100 lines) ==="
          curl -sS \
            --user "$JENKINS_USER:$JENKINS_API_TOKEN" \
            "$JENKINS_URL/job/$JOB_NAME/$BUILD_NUMBER/consoleText" \
          | tail -n 100
          exit 1
        fi
      fi
      echo "â³ ë¹Œë“œ ì§„í–‰ ì¤‘â€¦ (${elapsed}s)"
      sleep 10
      elapsed=$((elapsed + 10))
    done

    echo "âŒ Jenkins ë¹Œë“œ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼"
    exit 1
